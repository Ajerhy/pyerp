{% extends "base/dashboard.html" %}
{% load humanize %}
{% load bootstrap4 %}

{% bootstrap_css %}
{% bootstrap_javascript jquery='full' %}
{% bootstrap_messages %}

{% load i18n static %}
{% load erp_tags %}
{% block header %}
    <link rel="shortcut icon" href="{% static '.' %}/dist/favicon.png" type="image/x-icon"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="{% static '/plugins/fontawesome-free/css/all.min.css' %}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Toastr -->
    <link rel="stylesheet" href="{{ STATIC_URL }}plugins/toastr/toastr.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="{% static '/dist/css/adminlte.min.css' %}">
    <!-- Google Font: Source Sans Pro -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    {{ form.media }}
{% endblock header %}
{% block head %}
    <link rel="stylesheet" href="{% static 'css/formset.css' %}">
{% endblock %}
{% block content %}
  <div class="row" style="padding:5px;" >
    <div class="card card-outline col-12">
      <form method="post" class="form">
        <div class="card-header">
          {% include 'account/header.html' %}
        </div>
        <div class="card-body">
          <div class="form-row">
            {% if object %}
              <div class="form-group row col-sm-6">
                <label class="col-sm-2 col-xl-2 col-form-label" for="id_name">Name</label>
                <div class="col-sm-9">
                  <input type="text" value="{{ object.name }}" class="form-control"  style="width: 100%"  maxlength="80" disabled >
                  <span class="help-block">
                  </span>
                </div>
              </div>
            {% else %}
              <div class="form-group row col-sm-6">
                <label class="col-sm-2 col-xl-2 col-form-label" for="id_name">Name</label>
                <div class="col-sm-9">
                  <input type="text" value="Nuevo" class="form-control"  style="width: 100%"  maxlength="80" disabled >
                  <span class="help-block">
                  </span>
                </div>
              </div>
            {% endif %}
            {% csrf_token %}
            {% for field in form %}
              {% if field.auto_id != "id_note" %}
                <div class="form-group row col-sm-6">
                  <label class="col-sm-2 col-xl-2 col-form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                  <div class="col-sm-9">
                    {{ field }}
                    <span class="help-block">
                      {% for error in field.errors %}
                        <ul>
                          <li class="text-red">{{ error }}</li>
                        </ul>
                      {% endfor %}
                    </span>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
          <div class="tabular inline-related last-related">
            {{ formset.management_form }}
            <fieldset>
              <table id="formset_table" class="table table-striped">
                <thead>
                  <tr>
                    <th class="original"></th>
                    {% for field in formset.form %}
                      {% if not field.widget.is_hidden %}
                        <th class="column-{{ field.name }}">{{ field.label|capfirst }}</th>
                      {% endif %}
                    {% endfor %}
                    {% if formset.can_delete %}<th>a</th>{% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for inline_form in formset %}
                    <tr class="{% cycle 'row1' 'row2' %}" id="{{ formset.prefix }}-{{ forloop.counter0 }}">
                      <td class="original{%if field.errors %} table-danger{% endif %}">
                        {% for hidden in inline_form.hidden_fields %}
                          {{ hidden }}
                        {% endfor %}
                      </td>
                      {% for field in inline_form.visible_fields %}
                        <td class="{% if field.name %}field-{{ field.name }}{% endif %}{%if field.errors %} table-danger{% endif %}">
                            {{ field }}
                        </td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                  <tr class="formset-template" id="{{ formset.prefix }}-__prefix__" style="display: none">
                    <td class="original {%if field.errors %}table-danger{% endif %}">
                      {% for hidden in formset.empty_form.hidden_fields %}
                        {{ hidden }}
                      {% endfor %}
                    </td>
                    {% for field in formset.empty_form.visible_fields %}
                      <td class="{% if field.name %}field-{{ field.name }}{% endif %} {%if field.errors %}table-danger{% endif %}">
                          {{ field }}
                      </td>
                    {% endfor %}
                  </tr>
                </tbody>
                <tfoot>
                </tfoot>
              </table>
            </fieldset>
            <span id="add-row" class="add-row">Add form</span>
          </div>
        </div>
        <!-- /.card-body -->
        <div class="card-footer">
          <div class="row">
            <div class="col col-sm-7 col-md-8 col-lg-9 col-xl-10 font-weight-bold text-right">{{ _('Net Amount or Affection:') }}</div>
            <div class="col col-sm-5 col-md-4 col-lg-3 col-xl-2 text-right" id="t_amount_untaxed">$ {{ object.amount_untaxed|intcomma }}</div>
          </div>
          <div class="row">
            <div class="col col-sm-7 col-md-8 col-lg-9 col-xl-10 font-weight-bold text-right">{{ _('Exempt Amount:') }}</div>
            <div class="col col-sm-5 col-md-4 col-lg-3 col-xl-2 text-right" id="t_amount_exempt">$ {{ object.amount_exempt|intcomma }}</div>
          </div>
          <div class="row">
            <div class="col col-sm-7 col-md-8 col-lg-9 col-xl-10 font-weight-bold text-right">{{ _('IVA:') }}</div>
            <div class="col col-sm-5 col-md-4 col-lg-3 col-xl-2 text-right" id="t_amount_tax_iva">$ {{ object.amount_tax_iva|intcomma }}</div>
          </div>
          <div class="row">
            <div class="col col-sm-7 col-md-8 col-lg-9 col-xl-10 font-weight-bold text-right">{{ _('Other taxes:') }}</div>
            <div class="col col-sm-5 col-md-4 col-lg-3 col-xl-2 text-right" id="t_amount_tax_other">$ {{ object.amount_tax_other|intcomma }}</div>
          </div>
          <div class="row">
            <div class="col col-sm-7 col-md-8 col-lg-9 col-xl-10 font-weight-bold text-right">{{ _('Total taxes:') }}</div>
            <div class="col col-sm-5 col-md-4 col-lg-3 col-xl-2 text-right" id="t_amount_tax_total">$ {{ object.amount_tax_total|intcomma  }}</div>
          </div>
          <hr class="style1">
          <div class="row">
            <div class="col col-sm-7 col-md-8 col-lg-9 col-xl-10 font-weight-bold text-right">{{ _('Total:') }}</div>
            <div class="col col-sm-5 col-md-4 col-lg-3 col-xl-2 text-right" id="t_amount_total">$ {{ object.amount_total|intcomma }}</div>
          </div>
          <hr class="style1">
          <div class="form-group row">
            <label for="id_note" class="col-1 col-form-label">Note</label>
            <div class="col-11">
              <textarea name="note" cols="400" rows="1" class="form-control" data-placeholder="Notas de la factura ..." style="width: 100%" id="id_note">{{ object.note}}</textarea>
              <span class="help-block"></span>
            </div>
          </div>
        </div>
        <!-- /.card-footer -->
      </div>
      <!-- /.card -->
    </form>
  </div>
{% endblock %}
{% block scripts %}
<script type="text/javascript">
  $('#add-row').click(function() {
    var form_idx = $('#id_{{ formset.prefix }}-TOTAL_FORMS').val();
    form_cloned = $('<div>').append($('.formset-template').clone()).html().replace(/formset-template/g, '');
    form_cloned = form_cloned.replace(/__prefix__/g, form_idx);
    //alert(form_cloned);
    $('#formset_table tbody').append(form_cloned);
    $('#{{ formset.prefix }}-' + form_idx).show();
    $('#id_{{ formset.prefix }}-TOTAL_FORMS').val(parseInt(form_idx) + 1);

    $("#formset_table tbody tr:visible").each(function (index) {
      $(this).css("background-color", !!(index & 1)? "inherit" : "rgba(0,0,0,.05");
    });
  });

  function RecalculateFormset() {
    var formCount = $('#id_{{ formset.prefix }}-TOTAL_FORMS').val();
    var url = "{% url 'PyInvoice:ajax_load_tax' %}";
    var tax = [];
    var taxes;

    var amount_untaxed = 0
    var amount_exempt = 0
    var amount_tax_iva = 0
    var amount_tax_other = 0
    var amount_tax_total = 0
    var amount_total = 0

    var t_amount_untaxed = 0
    var t_amount_exempt = 0
    var t_amount_tax_iva = 0
    var t_amount_tax_other = 0
    var t_amount_tax_total = 0
    var t_amount_total = 0

    for (i = 0; i < formCount; i++) {
      var formset_row = document.getElementById('id_{{ formset.prefix }}-' + i + '-id').closest('tr');
      if(formset_row.style.display != "none"){
        price = parseFloat(document.getElementById('id_{{ formset.prefix }}-' + i + '-price').value);
        quantity = parseFloat(document.getElementById('id_{{ formset.prefix }}-' + i + '-quantity').value);
        descount = parseFloat(document.getElementById('id_{{ formset.prefix }}-' + i + '-discount').value);
        amount_untaxed += (quantity * price) - descount;

        tax = $("#id_{{ formset.prefix }}-" + i + "-tax_id").val()
        $.ajax({
          async: false,
          url: url,
          data: {
            'tax': tax,
          },
          success: function (data) {
            taxes = JSON.parse(data['tax']);
          }
        });

        if (taxes.length > 0){
          for (j = 0; j < taxes.length; j++) {
            var object = taxes[j]
            var tax_fields = object.fields;
            if (object.pk == 1){
              amount_tax_iva = (amount_untaxed * tax_fields.amount)/100
            }
            else{
              amount_tax_other += (amount_untaxed * tax_fields.amount)/100

            }
          }
        }
        else{
          amount_exempt = amount_untaxed
        }
        amount_total = amount_untaxed + amount_tax_iva + amount_tax_other
        if (i < formCount){
          document.getElementById('id_{{ formset.prefix }}-' + i + '-amount_total').value = amount_total.toFixed(2);
        }

        t_amount_untaxed += amount_untaxed
        t_amount_tax_iva += amount_tax_iva
        t_amount_tax_other += amount_tax_other
        t_amount_tax_total += amount_tax_iva + amount_tax_other
        t_amount_exempt += amount_exempt
        t_amount_total += amount_total

        amount_untaxed = 0
        amount_exempt = 0
        amount_tax_iva = 0
        amount_tax_other = 0
        amount_total = 0
      }
    }
    document.getElementById("t_amount_untaxed").innerHTML = "$ " + t_amount_untaxed.toFixed(2);
    document.getElementById("t_amount_exempt").innerHTML = "$ " + t_amount_exempt.toFixed(2);
    document.getElementById("t_amount_tax_iva").innerHTML = "$ " + t_amount_tax_iva.toFixed(2);
    document.getElementById("t_amount_tax_other").innerHTML = "$ " + t_amount_tax_other.toFixed(2);
    document.getElementById("t_amount_tax_total").innerHTML = "$ " + t_amount_tax_total.toFixed(2);
    document.getElementById("t_amount_total").innerHTML = "$ " + t_amount_total.toFixed(2);
  }

  $("[id^='id_{{ formset.prefix }}-'][id$='-product_id']").on("change", function (event) {
    FindProduct(event);
  });

  function FindProduct(event){
    var selected_element = $(event.currentTarget);
    var select_val = selected_element.val();
    var select_id = event.currentTarget.id;
    var index = select_id.replace( /(^.+\D)(\d+)(\D.+$)/i,'$2');
    var url = "{% url 'PyInvoice:ajax_load_product' %}";

    $.ajax({
      url: url,
      data: {
        'product': select_val
      },
      success: function (data) {
        var product = JSON.parse(data['product']);
        var object = product[0]
        var product_fields = object.fields;

        document.getElementById('id_{{ formset.prefix }}-' + index + '-description').value = product_fields.description;
        document.getElementById('id_{{ formset.prefix }}-' + index + '-uom_id').value = product_fields.uom_id;
        document.getElementById('id_{{ formset.prefix }}-' + index + '-price').value = product_fields.price;
      }
    });
  }

  $("[id^='id_{{ formset.prefix }}-']").on("change", function (e) {
    RecalculateFormset();
  });


  /* ======================= Recalculo del Invoice ======================== */
  /* cargar la página y se recalcula el asiento contable.                   */

  $(document).ready(function(){
    //$('#formset_table tfoot').append('<tr style="background-color: transparent;"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>');
    //RecalculateFormset();
  });
</script>
{% endblock %}
